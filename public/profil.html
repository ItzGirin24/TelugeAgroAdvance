<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - TelugeAgro</title>
    <link rel="icon" href="https://raw.githubusercontent.com/ItzGirin24/TelugeAgro/refs/heads/main/logo%20Teluge.jpg" type="image/x-icon">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, where, orderBy, getDocs, onSnapshot } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB2sLqWwZIxr65c3CcNgKCCjmDTeDlSnfY",
            authDomain: "telugeagro2025.firebaseapp.com",
            projectId: "telugeagro2025",
            storageBucket: "telugeagro2025.firebasestorage.app",
            messagingSenderId: "1029963109637",
            appId: "1:1029963109637:web:86824d0db45e1489b3136c",
            measurementId: "G-XF1JDPME66"
        };

        const app = initializeApp(firebaseConfig);
        window.firebaseAuth = getAuth(app);
        window.firebaseDb = getFirestore(app);
        window.doc = doc;
        window.getDoc = getDoc;
        window.collection = collection;
        window.query = query;
        window.where = where;
        window.orderBy = orderBy;
        window.getDocs = getDocs;
        window.onAuthStateChanged = onAuthStateChanged;
        window.signOut = signOut;
        window.onSnapshot = onSnapshot;
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            min-height: 100vh;
        }

        .glass-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 25px 45px rgba(0, 0, 0, 0.1);
        }

        .profile-card {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
        }

        .stat-card {
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(34, 197, 94, 0.2);
        }

        .order-item {
            transition: all 0.3s ease;
        }

        .order-item:hover {
            transform: translateX(5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-paid {
            background: #d1fae5;
            color: #065f46;
        }

        .status-processing {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-completed {
            background: #f3e8ff;
            color: #7c2d12;
        }

        .loading-skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .cart-item {
            background: #f8fafc;
            border-left: 4px solid #22c55e;
            transition: all 0.3s ease;
        }

        .cart-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.15);
        }

        @media (max-width: 640px) {
            .cart-item {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }

            .cart-item .flex.items-center.justify-between {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .cart-item h3 {
                font-size: 1rem;
            }

            .cart-item p {
                font-size: 0.875rem;
            }
        }

        #cart-summary {
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        #cart-summary .bg-white {
            border-left: 4px solid #22c55e;
        }

        @media (max-width: 640px) {
            #cart-summary .flex.justify-between {
                flex-direction: column;
                gap: 0.5rem;
                text-align: right;
            }

            #cart-summary .text-lg {
                font-size: 1.125rem;
            }
        }

        /* Mobile Menu Animation */
        .mobile-menu {
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
        }

        .mobile-menu.active {
            transform: translateX(0);
        }

        /* Progress Timeline Styles */
        .progress-timeline {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            margin: 16px 0;
        }

        .step {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
        }

        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 8px;
            position: relative;
            z-index: 3;
            transition: all 0.3s ease;
        }

        .step-circle.active {
            background-color: #22c55e;
            color: white;
            box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.3);
        }

        .step-circle.inactive {
            background-color: #e5e7eb;
            color: #6b7280;
        }

        .step-circle.completed,
        .step-circle.current {
            background-color: #22c55e;
            color: white;
            box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.3);
        }

        .step-label {
            font-size: 12px;
            text-align: center;
            font-weight: 500;
            min-width: 60px;
            transition: color 0.3s ease;
        }

        .step-label.active {
            color: #16a34a;
        }

        .step-label.inactive {
            color: #9ca3af;
        }

        .step-connector {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(50%);
            right: -50%;
            height: 2px;
            background-color: #e5e7eb;
            z-index: 1;
            transition: background-color 0.3s ease;
        }

        .step-connector.active {
            background-color: #22c55e;
        }

        .progress-fill {
            position: absolute;
            top: 20px;
            left: 0;
            height: 2px;
            background-color: #22c55e;
            border-radius: 1px;
            z-index: 0;
            transition: width 0.5s ease;
        }

        @media (max-width: 640px) {
            .progress-timeline {
                flex-wrap: wrap;
                gap: 8px;
            }

            .step {
                flex: none;
                width: 25%;
            }

            .step-connector {
                display: none;
            }

            .progress-fill {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Authentication Check -->
    <script>
        // Check authentication first
        if (!localStorage.getItem('adminLoggedIn') && !localStorage.getItem('userLoggedIn')) {
            window.location.href = 'login.html?redirect=profile.html';
        }
    </script>

    <br>
        <br>
            <br>
                <br>

    <!-- Navigation -->
    <nav class="fixed top-0 w-full z-40 transition-all duration-300" id="navbar" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 50%, #15803d 100%);">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16 md:h-20">
                <!-- Logo -->
                <div class="flex items-center space-x-3 hover-scale">
                    <img src="logo Teluge.jpg" alt="TelugeAgro Logo" class="w-10 h-10 md:w-12 md:h-12 rounded-full pulse-glow">
                    <span class="text-xl md:text-2xl font-bold text-white">TelugeAgro</span>
                </div>

                <!-- Desktop Menu -->
                <div class="hidden md:flex items-center space-x-8">
                    <a href="#home" class="nav-link text-white hover:text-green-200 transition-colors duration-300 font-medium">Beranda</a>
                    <a href="#about" class="nav-link text-white hover:text-green-200 transition-colors duration-300 font-medium">Tentang</a>
                    <a href="#products" class="nav-link text-white hover:text-green-200 transition-colors duration-300 font-medium">Produk</a>
                    <a href="#contact" class="nav-link text-white hover:text-green-200 transition-colors duration-300 font-medium">Kontak</a>
                    <a href="store.html" class="bg-white text-green-600 px-6 py-2 rounded-full font-semibold hover:bg-green-50 transition-all duration-300 btn-shine">
                        Beli Sekarang
                           </a>
                            <button onclick="logout()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors duration-300 font-medium">
                        Logout
                    </a>
                </div>

                <!-- Mobile Menu Button -->
                <button id="mobile-menu-btn" aria-controls="mobile-menu" aria-expanded="false" class="md:hidden text-white hover:text-green-200 transition-colors duration-300 cursor-pointer z-50">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Mobile Menu -->
        <div id="mobile-menu" class="mobile-menu md:hidden absolute top-full left-0 right-0 bg-green-700 border-t border-green-600 z-40">
            <div class="px-4 pt-2 pb-4 space-y-2">
                <a href="#home" class="block px-3 py-2 text-white hover:bg-green-600 rounded transition-colors duration-300">Beranda</a>
                <a href="#about" class="block px-3 py-2 text-white hover:bg-green-600 rounded transition-colors duration-300">Tentang</a>
                <a href="#products" class="block px-3 py-2 text-white hover:bg-green-600 rounded transition-colors duration-300">Produk</a>
                <a href="#contact" class="block px-3 py-2 text-white hover:bg-green-600 rounded transition-colors duration-300">Kontak</a>
                <a href="store.html" class="block px-3 py-2 bg-white text-green-600 rounded font-semibold hover:bg-green-50 transition-colors duration-300 text-center">
                    Beli Sekarang
                </a>
            </div>
        </div>
    </nav>


    <!-- Main Content -->
    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="max-w-6xl mx-auto">
            <!-- Profile Header -->
            <div class="profile-card rounded-3xl p-8 mb-8" data-aos="fade-down">
                <div class="flex flex-col md:flex-row items-center md:items-start space-y-6 md:space-y-0 md:space-x-8">
                    <div class="relative">
                        <img id="userAvatar" src="" alt="User Avatar" class="w-32 h-32 rounded-full border-4 border-white shadow-xl object-cover">
                        <div class="absolute -bottom-2 -right-2 bg-white rounded-full p-2">
                            <span id="userStatusIcon" class="text-2xl">‚úÖ</span>
                        </div>
                    </div>
                    <div class="text-center md:text-left flex-1">
                        <h1 id="userName" class="text-3xl md:text-4xl font-bold mb-2">Loading...</h1>
                        <p id="userEmail" class="text-xl opacity-90 mb-4">Loading...</p>
                        <div class="flex flex-wrap justify-center md:justify-start gap-3">
                            <span id="userRole" class="px-4 py-2 bg-white bg-opacity-20 rounded-full text-sm font-semibold">Loading...</span>
                            <span id="memberSince" class="px-4 py-2 bg-white bg-opacity-20 rounded-full text-sm font-semibold">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statistics -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-8" data-aos="fade-up">
                <div class="stat-card glass-container rounded-2xl p-6 text-center">
                    <div class="text-3xl mb-2">üõí</div>
                    <div class="text-2xl font-bold text-green-600" id="cartItemsCount">0</div>
                    <div class="text-sm text-gray-600">Item di Keranjang</div>
                </div>
                <div class="stat-card glass-container rounded-2xl p-6 text-center">
                    <div class="text-3xl mb-2">üì¶</div>
                    <div class="text-2xl font-bold text-blue-600" id="totalOrders">0</div>
                    <div class="text-sm text-gray-600">Total Pesanan</div>
                </div>
                <div class="stat-card glass-container rounded-2xl p-6 text-center">
                    <div class="text-3xl mb-2">üí∞</div>
                    <div class="text-2xl font-bold text-yellow-600" id="totalSpent">Rp 0</div>
                    <div class="text-sm text-gray-600">Total Belanja</div>
                </div>
                <div class="stat-card glass-container rounded-2xl p-6 text-center">
                    <div class="text-3xl mb-2">‚≠ê</div>
                    <div class="text-2xl font-bold text-purple-600" id="loyaltyPoints">0</div>
                    <div class="text-sm text-gray-600">Poin Loyalitas</div>
                </div>
            </div>

            <!-- Content Tabs -->
            <div class="glass-container rounded-2xl overflow-hidden mb-8" data-aos="fade-up" data-aos-delay="200">
                <!-- Tab Navigation -->
                <div class="border-b border-gray-200">
                    <nav class="flex space-x-0">
                        <button onclick="showTab('cart')" class="tab-btn active flex-1 py-4 px-6 text-center font-semibold transition-all bg-green-50 text-green-600 border-b-2 border-green-600" id="cart-tab">
                            üõí Keranjang Saya
                        </button>
                        <button onclick="showTab('orders')" class="tab-btn flex-1 py-4 px-6 text-center font-semibold transition-all text-gray-500 hover:text-gray-700" id="orders-tab">
                            üì¶ Riwayat Pesanan
                        </button>
                        <button onclick="showTab('history')" class="tab-btn flex-1 py-4 px-6 text-center font-semibold transition-all text-gray-500 hover:text-gray-700" id="history-tab">
                            üìà Aktivitas Belanja
                        </button>
                    </nav>
                </div>

                <!-- Tab Content -->
                <div class="p-6">
                    <!-- Cart Tab -->
                    <div id="cart-content" class="tab-content">
                        <h2 class="text-2xl font-bold mb-6">Item di Keranjang Anda</h2>
                        <div id="cart-items-container">
                            <!-- Cart items will be loaded here -->
                        </div>

                        <!-- Cart Summary -->
                        <div id="cart-summary" class="mt-6 hidden">
                            <div class="bg-white rounded-xl p-6 border border-gray-200 shadow-sm">
                                <div class="space-y-3 mb-4">
                                    <div class="flex justify-between text-sm">
                                        <span class="text-gray-600">Subtotal</span>
                                        <span id="subtotal" class="font-semibold">Rp 0</span>
                                    </div>
          
                                </div>
                                <div class="border-t pt-4 mb-4">
                                    <div class="flex justify-between text-lg font-bold">
                                        <span>Total</span>
                                        <span id="grand-total" class="text-green-600">Rp 0</span>
                                    </div>
                                </div>
                                <a href="cart.html" class="w-full block bg-green-600 text-white py-3 px-6 rounded-lg text-center font-semibold hover:bg-green-700 transition-all duration-300 text-lg">
                                    Checkout Sekarang
                                </a>
                            </div>
                        </div>

                        <div id="cart-empty" class="text-center py-12 hidden">
                            <div class="text-6xl mb-4">üõí</div>
                            <h3 class="text-xl font-bold text-gray-700 mb-2">Keranjang Masih Kosong</h3>
                            <p class="text-gray-500 mb-6">Mulai belanja untuk melihat item di sini</p>
                            <a href="store.html" class="inline-block bg-green-600 text-white px-8 py-3 rounded-full font-semibold hover:bg-green-700 transition-all">
                                Mulai Belanja
                            </a>
                        </div>
                    </div>

                    <!-- Orders Tab -->
                    <div id="orders-content" class="tab-content hidden">
                        <h2 class="text-2xl font-bold mb-6">Riwayat Pesanan</h2>
                        <div id="orders-container">
                            <!-- Orders will be loaded here -->
                        </div>
                        <div id="orders-empty" class="text-center py-12 hidden">
                            <div class="text-6xl mb-4">üì¶</div>
                            <h3 class="text-xl font-bold text-gray-700 mb-2">Belum Ada Pesanan</h3>
                            <p class="text-gray-500 mb-6">Riwayat pesanan Anda akan muncul di sini</p>
                            <a href="store.html" class="inline-block bg-green-600 text-white px-8 py-3 rounded-full font-semibold hover:bg-green-700 transition-all">
                                Belanja Sekarang
                            </a>
                        </div>
                    </div>

                    <!-- History Tab -->
                    <div id="history-content" class="tab-content hidden">
                        <h2 class="text-2xl font-bold mb-6">Aktivitas Belanja</h2>
                        <div id="history-container">
                            <!-- History will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4" data-aos="fade-up" data-aos-delay="400">
                <a href="store.html" class="glass-container rounded-xl p-6 text-center hover:shadow-lg transition-all">
                    <div class="text-3xl mb-2">üõçÔ∏è</div>
                    <div class="font-semibold text-gray-700">Belanja Lagi</div>
                </a>
                <a href="cart.html" class="glass-container rounded-xl p-6 text-center hover:shadow-lg transition-all">
                    <div class="text-3xl mb-2">üõí</div>
                    <div class="font-semibold text-gray-700">Lihat Keranjang</div>
                </a>
>
                <a href="https://wa.me/628112638318" target="_blank" class="glass-container rounded-xl p-6 text-center hover:shadow-lg transition-all">
                    <div class="text-3xl mb-2">üìû</div>
                    <div class="font-semibold text-gray-700">Bantuan</div>
                </a>
            </div>
        </div>
    </main>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg transform translate-x-full transition-all duration-300 z-50">
        <span id="toast-message"></span>
    </div>

    <script>
        // Initialize AOS
        AOS.init({
            duration: 800,
            once: true,
            offset: 100
        });

        // Mobile menu toggle
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const mobileMenu = document.getElementById('mobile-menu');

        mobileMenuBtn.addEventListener('click', () => {
            mobileMenu.classList.toggle('active');
        });

        // Global variables
        let currentUser = null;
        let userUID = null;
        let ordersUnsubscribe = null;
        let cartItems = {};
        let allProducts = [];

        // Initialize when page loads
        window.addEventListener('load', async () => {
            try {
                userUID = localStorage.getItem('userUID') || 'guest';
                await loadUserProfile();
                await loadUserStats();
                await loadCart();
                
                // Set up auth state listener for Firebase users
                if (window.firebaseAuth) {
                    onAuthStateChanged(firebaseAuth, (user) => {
                        if (user) {
                            currentUser = user;
                            userUID = user.uid;
                            loadCart(); // Reload cart on auth change
                        }
                    });
                }
            } catch (error) {
                console.error('Initialization error:', error);
                showToast('Gagal memuat profil', 'error');
            }
        });

        // Load user profile
        async function loadUserProfile() {
            try {
                const userName = localStorage.getItem('userName') || 'User';
                const userEmail = localStorage.getItem('userEmail') || '';
                const userPhoto = localStorage.getItem('userPhoto') || 'https://raw.githubusercontent.com/ItzGirin24/TelugeAgro/refs/heads/main/logo%20Teluge.jpg';
                const isAdmin = localStorage.getItem('adminLoggedIn') === 'true';

                // Update profile info
                document.getElementById('userName').textContent = userName;
                document.getElementById('userEmail').textContent = userEmail;
                document.getElementById('userAvatar').src = userPhoto;
                document.getElementById('userRole').textContent = isAdmin ? 'üëë Admin' : 'üõçÔ∏è Customer';

                // Set member since date
                const memberSince = localStorage.getItem('memberSince') || new Date().toLocaleDateString('id-ID');
                document.getElementById('memberSince').textContent = `üìÖ Member sejak ${memberSince}`;

                // Try to load from Firebase if available
                if (currentUser && window.firebaseDb) {
                    const userRef = doc(firebaseDb, 'users', currentUser.uid);
                    const userDoc = await getDoc(userRef);
                    
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        if (userData.createdAt) {
                            const createdDate = userData.createdAt.toDate().toLocaleDateString('id-ID');
                            document.getElementById('memberSince').textContent = `üìÖ Member sejak ${createdDate}`;
                        }
                    }
                }

            } catch (error) {
                console.error('Error loading user profile:', error);
            }
        }

        // Load user statistics
        async function loadUserStats() {
            try {
                // Load cart count from global cartItems
                const items = Object.values(cartItems);
                const cartCount = items.reduce((sum, item) => sum + (item.quantity || 0), 0);
                document.getElementById('cartItemsCount').textContent = cartCount;

                // Load order statistics from Firebase
                if (window.firebaseDb) {
                    const userEmail = localStorage.getItem('userEmail');
                    if (!userEmail) return;

            const ordersQuery = query(
                collection(firebaseDb, 'orders'),
                where('email', '==', userEmail),
                where('status', 'in', ['process', 'packing', 'shipping'])
            );

                    const ordersSnapshot = await getDocs(ordersQuery);
                    const orders = ordersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                    document.getElementById('totalOrders').textContent = orders.length;

                    // Calculate total spent
                    const totalSpent = orders.reduce((sum, order) => sum + (order.total || 0), 0);
                    document.getElementById('totalSpent').textContent = `Rp ${formatPrice(totalSpent)}`;

                    // Calculate loyalty points (10% of total spent)
                    const loyaltyPoints = Math.floor(totalSpent / 1000);
                    document.getElementById('loyaltyPoints').textContent = loyaltyPoints;
                }

            } catch (error) {
                console.error('Error loading user stats:', error);
            }
        }

        // Load cart from Firebase (with localStorage fallback)
        async function loadCart() {
            if (!userUID || userUID === 'guest') {
                cartItems = {};
                renderCartItems();
                return;
            }

            try {
                // Try Firebase first
                if (window.firebaseDb && window.doc && window.getDoc) {
                    const cartRef = doc(firebaseDb, 'carts', userUID);
                    const cartSnap = await getDoc(cartRef);

                    if (cartSnap.exists()) {
                        cartItems = cartSnap.data().items || {};
                        console.log('Cart loaded from Firebase');
                    } else {
                        // Fallback to localStorage
                        const cartData = localStorage.getItem(`cart_${userUID}`);
                        cartItems = JSON.parse(cartData) || {};
                        console.log('Cart loaded from localStorage');
                    }
                } else {
                    // Only localStorage if no Firebase
                    const cartData = localStorage.getItem(`cart_${userUID}`);
                    cartItems = JSON.parse(cartData) || {};
                }

                // Load products for images
                await loadProducts();

                renderCartItems();
                loadUserStats();
            } catch (error) {
                console.error('Error loading cart:', error);
                // Fallback to localStorage
                const cartData = localStorage.getItem(`cart_${userUID}`);
                cartItems = JSON.parse(cartData) || {};
                renderCartItems();
                loadUserStats();
            }
        }

        // Load products for images
        async function loadProducts() {
            if (!window.firebaseDb) return;

            try {
                const productsQuery = query(collection(firebaseDb, 'products'), orderBy('createdAt', 'desc'));
                const querySnapshot = await getDocs(productsQuery);

                allProducts = [];
                querySnapshot.forEach((doc) => {
                    const productData = doc.data();
                    allProducts.push({
                        id: doc.id,
                        title: productData.title || productData.name, // Handle different field names
                        image: productData.image || 'https://via.placeholder.com/60x60?text=üçå',
                        price: productData.price || 0
                    });
                });
            } catch (error) {
                console.error('Error loading products:', error);
            }
        }

        // Render cart items
        function renderCartItems() {
            const cartContainer = document.getElementById('cart-items-container');
            const cartEmpty = document.getElementById('cart-empty');
            const cartSummary = document.getElementById('cart-summary');
            const subtotalEl = document.getElementById('subtotal');
            const grandTotalEl = document.getElementById('grand-total');
            
            const items = Object.values(cartItems);

            if (items.length === 0) {
                cartContainer.innerHTML = '';
                cartEmpty.classList.remove('hidden');
                cartSummary.classList.add('hidden');
                return;
            }

            cartEmpty.classList.add('hidden');
            
            // Calculate totals
            const subtotal = items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      
            const grandTotal = subtotal 
            
            subtotalEl.textContent = `Rp ${formatPrice(subtotal)}`;
            grandTotalEl.textContent = `Rp ${formatPrice(grandTotal)}`;
            
            cartContainer.innerHTML = items.map(item => {
                // Find product image
                const productData = allProducts.find(p => p.title === item.product);
                const productImage = productData ? productData.image : 'https://via.placeholder.com/64x64?text=üçå';

                return `
                    <div class="cart-item rounded-xl p-4 mb-4 bg-white shadow-sm border border-gray-100 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
                        <div class="flex items-center gap-3 flex-1">
                            <img src="${productImage}" alt="${item.product}" class="w-16 h-16 rounded-lg object-cover shadow-md" onerror="this.src='https://via.placeholder.com/64x64?text=üçå'">
                            <div class="flex-1 min-w-0">
                                <h3 class="font-semibold text-gray-800 text-sm sm:text-base truncate">${item.product}</h3>
                                <p class="text-xs sm:text-sm text-gray-600">Rp ${formatPrice(item.price)} / kg</p>
                                <p class="text-xs sm:text-sm font-medium text-green-600">${item.quantity} kg</p>
                            </div>
                        </div>
                        <div class="flex items-center justify-between w-full sm:w-auto gap-2 sm:gap-0">
                            <p class="text-base sm:text-lg font-bold text-gray-800">Rp ${formatPrice(item.price * item.quantity)}</p>
                            <button onclick="removeFromCart('${item.product}')" class="p-2 text-red-500 hover:text-red-700 transition-colors rounded-full hover:bg-red-50" title="Hapus item">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            cartSummary.classList.remove('hidden');
        }

        // Load order history with real-time updates
        function loadOrderHistory() {
            const ordersContainer = document.getElementById('orders-container');
            const ordersEmpty = document.getElementById('orders-empty');

            if (!window.firebaseDb) {
                ordersContainer.innerHTML = '<p class="text-gray-500 text-center">Riwayat pesanan tidak tersedia</p>';
                return;
            }

            const userEmail = localStorage.getItem('userEmail');
            if (!userEmail) {
                ordersContainer.innerHTML = '<p class="text-gray-500 text-center">Silakan login terlebih dahulu</p>';
                return;
            }

            // Unsubscribe previous listener if exists
            if (ordersUnsubscribe) {
                ordersUnsubscribe();
            }

            // Show loading
            ordersContainer.innerHTML = '<div class="text-center py-8"><div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"></div></div>';

            const ordersQuery = query(
                collection(firebaseDb, 'orders'),
                where('email', '==', userEmail),
                where('status', 'not-in', ['delivered', 'completed'])
            );

            // Set up real-time listener
            ordersUnsubscribe = onSnapshot(ordersQuery, (snapshot) => {
                try {
                    const orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                    // Sort by timestamp desc
                    orders.sort((a, b) => b.timestamp?.toDate() - a.timestamp?.toDate());

                    if (orders.length === 0) {
                        ordersContainer.innerHTML = '';
                        ordersEmpty.classList.remove('hidden');
                        return;
                    }

                    ordersEmpty.classList.add('hidden');

                    ordersContainer.innerHTML = orders.map(order => {
                        const statusInfo = getOrderStatusInfo(order.status || 'process');
                        return `
                        <div class="order-item bg-white rounded-xl p-6 mb-4 border-l-4 ${statusInfo.borderColor} shadow-md hover:shadow-xl transition-all duration-300" data-order-id="${order.id}">
                            <!-- Order Header -->
                            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-3">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-2">
                                        <h3 class="font-bold text-lg text-gray-800">Order #${order.id.slice(-8).toUpperCase()}</h3>
                                        <button onclick="copyOrderId('${order.id}')" class="text-gray-400 hover:text-green-600 transition-colors" title="Copy Order ID">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                            </svg>
                                        </button>
                                    </div>
                                    <p class="text-sm text-gray-600 flex items-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                        </svg>
                                        ${order.timestamp?.toDate().toLocaleDateString('id-ID', {
                                            year: 'numeric',
                                            month: 'long',
                                            day: 'numeric',
                                            hour: '2-digit',
                                            minute: '2-digit'
                                        })}
                                    </p>
                                </div>
                                <div class="flex flex-col gap-2 items-end">
                                    <span class="status-badge ${statusInfo.bgColor} ${statusInfo.textColor} flex items-center gap-2">
                                        ${statusInfo.icon} ${statusInfo.text}
                                    </span>
                                    <span class="status-badge ${order.paymentStatus === 'paid' ? 'bg-green-100 text-green-800' : 'bg-orange-100 text-orange-800'} text-xs">
                                        ${order.paymentStatus === 'paid' ? '‚úì Sudah Bayar' : '‚è≥ Belum Dibayar'}
                                    </span>
                                </div>
                            </div>

                            <!-- Progress Timeline -->
                            <div class="mb-6 bg-gray-50 rounded-lg p-4">
                                <h4 class="text-sm font-semibold text-gray-700 mb-3">Progress Pengiriman</h4>
                                <div class="progress-timeline">
                                    ${['process', 'packing', 'shipping', 'delivered'].map((step, index) => {
                                        const stepInfo = getOrderStatusInfo(step);
                                        const currentStep = ['process', 'packing', 'shipping', 'delivered'].indexOf(order.status || 'process');
                                        const isCompleted = index < currentStep || (currentStep === 3 && index === currentStep);
                                        const isCurrent = index === currentStep && currentStep < 3;
                                        const isPending = index > currentStep;
                                        const isLabelActive = index <= currentStep;
                                        const isConnectorActive = index < currentStep;
                                        const circleClass = isCompleted ? 'completed' : isCurrent ? 'current' : 'inactive';
                                        const labelClass = isLabelActive ? 'active' : 'inactive';
                                        const circleContent = isCompleted ? '‚úì' : (index + 1);
                                        return `
                                        <div class="step">
                                            <div class="step-circle ${circleClass}">
                                                ${circleContent}
                                            </div>
                                            <span class="step-label ${labelClass}">${stepInfo.shortText}</span>
                                            ${index < 3 ? `<div class="step-connector ${isConnectorActive ? 'active' : ''}"></div>` : ''}
                                        </div>
                                        `;
                                    }).join('')}
                                    <div class="progress-fill" style="width: ${(['process', 'packing', 'shipping', 'delivered'].indexOf(order.status || 'process') + 1) * 25}%"></div>
                                </div>

                                <!-- Shipping Info -->
                                ${order.trackingNumber ? `
                                <div class="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-2 text-sm">
                                        <div>
                                            <span class="text-gray-600">Kurir:</span>
                                            <span class="font-semibold text-gray-800 ml-1">${order.courierName || '-'}</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-600">No. Resi:</span>
                                            <span class="font-semibold text-gray-800 ml-1">${order.trackingNumber}</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-600">Estimasi:</span>
                                            <span class="font-semibold text-gray-800 ml-1">${order.estimatedDelivery || '-'}</span>
                                        </div>
                                    </div>
                                </div>
                                ` : ''}
                            </div>

                            <!-- Order Details -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <h4 class="text-sm font-semibold text-gray-700 mb-3">Produk Pesanan</h4>
                                    <div class="space-y-2">
                                        ${order.items?.map(item => `
                                            <div class="flex justify-between items-center text-sm p-2 bg-gray-50 rounded">
                                                <span class="text-gray-700">${item.product}</span>
                                                <span class="text-gray-600">${item.quantity}kg √ó Rp ${formatPrice(item.price)}</span>
                                            </div>
                                        `).join('') || ''}
                                    </div>
                                </div>
                                <div>
                                    <h4 class="text-sm font-semibold text-gray-700 mb-3">Alamat Pengiriman</h4>
                                    <p class="text-sm text-gray-600 mb-4">${formatAddress(order)}</p>
                                    <div class="text-right">
                                        <p class="text-sm text-gray-600 mb-1">Total Pembayaran</p>
                                        <p class="text-3xl font-bold text-green-600">Rp ${formatPrice(order.total)}</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Action Buttons -->

                                <button onclick="downloadReceipt('${order.id}')" class="flex-1 md:flex-none bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors font-medium flex items-center justify-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    Download
                                    
                                </button>

                        `;
                    }).join('');



                } catch (error) {
                    console.error('Error processing order snapshot:', error);
                    ordersContainer.innerHTML = '<p class="text-red-500 text-center">Gagal memuat riwayat pesanan</p>';
                }
            }, (error) => {
                console.error('Error listening to orders:', error);
                ordersContainer.innerHTML = '<p class="text-red-500 text-center">Gagal memuat riwayat pesanan</p>';
            });
        }

        // Helper function to format address
        function formatAddress(order) {
            const addressFields = [
                order.shippingAddress,
                order.deliveryAddress,
                order.address,
                order.customerAddress
            ];

            for (const addr of addressFields) {
                if (addr) {
                    if (typeof addr === 'string') {
                        return addr;
                    } else if (typeof addr === 'object') {
                        const parts = [];
                        if (addr.street) parts.push(addr.street);
                        if (addr.city) parts.push(addr.city);
                        if (addr.province) parts.push(addr.province);
                        if (addr.postalCode) parts.push(addr.postalCode);
                        if (addr.country) parts.push(addr.country);
                        return parts.join(', ');
                    }
                }
            }
            return 'Alamat tidak tersedia';
        }

        // Get order status info
        function getOrderStatusInfo(status) {
            const statusMap = {
                'process': {
                    text: 'Diproses',
                    shortText: 'Proses',
                    icon: '‚è≥',
                    bgColor: 'bg-blue-100',
                    textColor: 'text-blue-800',
                    borderColor: 'border-blue-500'
                },
                'packing': {
                    text: 'Sedang Dikemas',
                    shortText: 'Dikemas',
                    icon: 'üì¶',
                    bgColor: 'bg-yellow-100',
                    textColor: 'text-yellow-800',
                    borderColor: 'border-yellow-500'
                },
                'shipping': {
                    text: 'Dalam Pengiriman',
                    shortText: 'Dikirim',
                    icon: 'üöö',
                    bgColor: 'bg-purple-100',
                    textColor: 'text-purple-800',
                    borderColor: 'border-purple-500'
                },
                'delivered': {
                    text: 'Sampai Tujuan',
                    shortText: 'Sampai',
                    icon: '‚úÖ',
                    bgColor: 'bg-green-100',
                    textColor: 'text-green-800',
                    borderColor: 'border-green-500'
                },
                'completed': {
                    text: 'Selesai',
                    shortText: 'Selesai',
                    icon: 'üéâ',
                    bgColor: 'bg-green-100',
                    textColor: 'text-green-800',
                    borderColor: 'border-green-500'
                },
                'cancelled': {
                    text: 'Dibatalkan',
                    shortText: 'Batal',
                    icon: '‚ùå',
                    bgColor: 'bg-red-100',
                    textColor: 'text-red-800',
                    borderColor: 'border-red-500'
                }
            };
            return statusMap[status] || statusMap['process'];
        }

        // Tab management
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });

            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-green-50', 'text-green-600', 'border-b-2', 'border-green-600');
                btn.classList.add('text-gray-500', 'hover:text-gray-700');
            });

            // Show selected tab
            document.getElementById(`${tabName}-content`).classList.remove('hidden');
            
            // Add active class to selected tab button
            const activeBtn = document.getElementById(`${tabName}-tab`);
            activeBtn.classList.remove('text-gray-500', 'hover:text-gray-700');
            activeBtn.classList.add('active', 'bg-green-50', 'text-green-600', 'border-b-2', 'border-green-600');

            // Load content based on tab
            if (tabName === 'orders') {
                loadOrderHistory();
            } else if (tabName === 'history') {
                loadShoppingHistory();
            }
        }

        // Load shopping history
        async function loadShoppingHistory() {
            const historyContainer = document.getElementById('history-container');
            
            try {
                // Load cart history from localStorage
                const cartHistory = JSON.parse(localStorage.getItem(`cartHistory_${userUID}`)) || [];
                
                // Load completed orders from Firebase
                let completedOrders = [];
                if (window.firebaseDb && userUID !== 'guest') {
                    const userEmail = localStorage.getItem('userEmail');
                    if (userEmail) {
                        const ordersQuery = query(
                            collection(firebaseDb, 'orders'),
                            where('email', '==', userEmail),
                            where('status', 'in', ['delivered', 'completed'])
                        );
                        const ordersSnapshot = await getDocs(ordersQuery);
                        completedOrders = ordersSnapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data(),
                            type: 'order_completed',
                            timestamp: doc.data().timestamp?.toDate() || new Date()
                        })).sort((a, b) => b.timestamp - a.timestamp);
                    }
                }
                
                // Combine cart history and completed orders
                const allActivities = [
                    ...cartHistory.map(activity => ({
                        ...activity,
                        type: 'cart_action',
                        timestamp: new Date(activity.timestamp)
                    })),
                    ...completedOrders
                ].sort((a, b) => b.timestamp - a.timestamp);
                
                if (allActivities.length === 0) {
                    historyContainer.innerHTML = `
                        <div class="text-center py-12">
                            <div class="text-6xl mb-4">üìà</div>
                            <h3 class="text-xl font-bold text-gray-700 mb-2">Belum Ada Aktivitas</h3>
                            <p class="text-gray-500">Riwayat aktivitas belanja Anda akan muncul di sini</p>
                        </div>
                    `;
                    return;
                }

                historyContainer.innerHTML = allActivities.map(activity => {
                    if (activity.type === 'cart_action') {
                        return `
                            <div class="bg-white rounded-xl p-4 mb-3 border border-gray-200 flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <div class="text-2xl">${activity.action === 'add' ? '‚ûï' : activity.action === 'remove' ? '‚ûñ' : 'üõí'}</div>
                                    <div>
                                        <p class="font-semibold text-gray-800">${activity.productName}</p>
                                        <p class="text-sm text-gray-600">${activity.action === 'add' ? 'Ditambahkan ke keranjang' : 'Dihapus dari keranjang'}</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="text-sm text-gray-500">${activity.timestamp.toLocaleDateString('id-ID')}</p>
                                    <p class="text-sm font-medium text-green-600">${activity.quantity} kg</p>
                                </div>
                            </div>
                        `;
                    } else if (activity.type === 'order_completed') {
                        const statusInfo = getOrderStatusInfo(activity.status);
                        return `
                            <div class="order-item bg-white rounded-xl p-6 mb-4 border-l-4 ${statusInfo.borderColor} shadow-md hover:shadow-xl transition-all duration-300" data-order-id="${activity.id}">
                                <!-- Order Header -->
                                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-3">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-2 mb-2">
                                            <h3 class="font-bold text-lg text-gray-800">Order #${activity.id.slice(-8).toUpperCase()}</h3>
                                            <button onclick="copyOrderId('${activity.id}')" class="text-gray-400 hover:text-green-600 transition-colors" title="Copy Order ID">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                                </svg>
                                            </button>
                                        </div>
                                        <p class="text-sm text-gray-600 flex items-center gap-2">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                            </svg>
                                            ${activity.timestamp.toLocaleDateString('id-ID', {
                                                year: 'numeric',
                                                month: 'long',
                                                day: 'numeric',
                                                hour: '2-digit',
                                                minute: '2-digit'
                                            })}
                                        </p>
                                    </div>
                                    <div class="flex flex-col gap-2 items-end">
                                        <span class="status-badge ${statusInfo.bgColor} ${statusInfo.textColor} flex items-center gap-2">
                                            ${statusInfo.icon} ${statusInfo.text}
                                        </span>
                                        <span class="status-badge ${activity.paymentStatus === 'paid' ? 'bg-green-100 text-green-800' : 'bg-orange-100 text-orange-800'} text-xs">
                                            ${activity.paymentStatus === 'paid' ? '‚úì Sudah Bayar' : '‚è≥ Belum Dibayar'}
                                        </span>
                                    </div>
                                </div>

                                <!-- Progress Timeline (Simplified for History) -->
                                <div class="mb-4 bg-gray-50 rounded-lg p-3">
                                    <h4 class="text-sm font-semibold text-gray-700 mb-2">Status Pesanan</h4>
                                    <span class="status-badge ${statusInfo.bgColor} ${statusInfo.textColor} flex items-center gap-2 text-sm">
                                        ${statusInfo.icon} ${statusInfo.text}
                                    </span>
                                </div>

                                <!-- Order Details -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <h4 class="text-sm font-semibold text-gray-700 mb-2">Produk Pesanan</h4>
                                        <div class="space-y-1">
                                            ${activity.items?.map(item => `
                                                <div class="flex justify-between items-center text-xs p-1 bg-gray-50 rounded">
                                                    <span class="text-gray-700">${item.product}</span>
                                                    <span class="text-gray-600">${item.quantity}kg √ó Rp ${formatPrice(item.price)}</span>
                                                </div>
                                            `).join('') || ''}
                                        </div>
                                    </div>
                                    <div>
                                        <h4 class="text-sm font-semibold text-gray-700 mb-2">Alamat Pengiriman</h4>
                                        <p class="text-xs text-gray-600">${formatAddress(activity)}</p>
                                    </div>
                                </div>

                                <!-- Total -->
                                <div class="text-right">
                                    <p class="text-sm text-gray-600 mb-1">Total Pembayaran</p>
                                    <p class="text-xl font-bold text-green-600">Rp ${formatPrice(activity.total)}</p>
                                </div>


                                </div>
                            </div>
                        `;
                    }
                    return '';
                }).join('');
                
            } catch (error) {
                console.error('Error loading shopping history:', error);
                // Fallback to cart history only
                const cartHistory = JSON.parse(localStorage.getItem(`cartHistory_${userUID}`)) || [];
                if (cartHistory.length === 0) {
                    historyContainer.innerHTML = `
                        <div class="text-center py-12">
                            <div class="text-6xl mb-4">üìà</div>
                            <h3 class="text-xl font-bold text-gray-700 mb-2">Belum Ada Aktivitas</h3>
                            <p class="text-gray-500">Riwayat aktivitas belanja Anda akan muncul di sini</p>
                        </div>
                    `;
                } else {
                    historyContainer.innerHTML = cartHistory.map(activity => `
                        <div class="bg-white rounded-xl p-4 mb-3 border border-gray-200 flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="text-2xl">${activity.action === 'add' ? '‚ûï' : activity.action === 'remove' ? '‚ûñ' : 'üõí'}</div>
                                <div>
                                    <p class="font-semibold text-gray-800">${activity.productName}</p>
                                    <p class="text-sm text-gray-600">${activity.action === 'add' ? 'Ditambahkan ke keranjang' : 'Dihapus dari keranjang'}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-sm text-gray-500">${new Date(activity.timestamp).toLocaleDateString('id-ID')}</p>
                                <p class="text-sm font-medium text-green-600">${activity.quantity} kg</p>
                            </div>
                        </div>
                    `).join('');
                }
            }
        }

        // Utility functions
        function formatPrice(price) {
            return new Intl.NumberFormat('id-ID').format(Math.round(price));
        }

        function getStatusClass(status) {
            const classes = {
                'pending': 'status-pending',
                'paid': 'status-paid',
                'processing': 'status-processing',
                'completed': 'status-completed'
            };
            return classes[status] || 'status-pending';
        }

        function getStatusText(status) {
            const texts = {
                'pending': 'Menunggu Bayar',
                'paid': 'Dibayar',
                'processing': 'Diproses',
                'completed': 'Selesai'
            };
            return texts[status] || 'Unknown';
        }

        // Cart management
        function removeFromCart(productName) {
            if (confirm(`Hapus ${productName} dari keranjang?`)) {
                const cart = JSON.parse(localStorage.getItem(`cart_${userUID}`)) || {};
                delete cart[productName];
                localStorage.setItem(`cart_${userUID}`, JSON.stringify(cart));
                
                // Add to history
                addToCartHistory('remove', productName);
                
                loadCartItems();
                loadUserStats();
                showToast(`${productName} dihapus dari keranjang`);
            }
        }

        function clearCart() {
            if (confirm('Kosongkan semua item di keranjang?')) {
                localStorage.setItem(`cart_${userUID}`, JSON.stringify({}));
                loadCartItems();
                loadUserStats();
                showToast('Keranjang berhasil dikosongkan');
            }
        }

        // Add activity to cart history
        function addToCartHistory(action, productName, quantity = 1) {
            const cartHistory = JSON.parse(localStorage.getItem(`cartHistory_${userUID}`)) || [];
            cartHistory.unshift({
                action,
                productName,
                quantity,
                timestamp: new Date().toISOString()
            });
            
            // Keep only last 50 activities
            if (cartHistory.length > 50) {
                cartHistory.splice(50);
            }
            
            localStorage.setItem(`cartHistory_${userUID}`, JSON.stringify(cartHistory));
        }

        // Navigation functions
        function viewOrderDetails(orderId) {
            // Redirect to pesanan.html with order ID
            window.location.href = `pesanan.html?orderId=${orderId}`;
        }

        function trackOrder(orderId) {
            // Redirect to tracking page
            window.location.href = `pesanan.html?orderId=${orderId}`;
        }

        function downloadReceipt(orderId) {
            showToast('Mengunduh receipt...', 'success');
            
            // Simple receipt download (you can enhance this with jsPDF)
            setTimeout(() => {
                window.print();
            }, 500);
        }

        function copyOrderId(orderId) {
            navigator.clipboard.writeText(orderId).then(() => {
                showToast('Order ID berhasil disalin!', 'success');
            }).catch(() => {
                showToast('Gagal menyalin Order ID', 'error');
            });
        }

        async function logout() {
            if (confirm('Yakin ingin logout?')) {
                try {
                    // Sign out from Firebase if available
                    if (window.signOut && window.firebaseAuth) {
                        await signOut(firebaseAuth);
                    }
                } catch (error) {
                    console.error('Error signing out from Firebase:', error);
                }

                // Clear local storage
                localStorage.clear();

                // Redirect to login page
                window.location.href = 'login.html';
            }
        }

        // Toast notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            
            toast.className = `fixed top-4 right-4 text-white px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 z-50 ${type === 'error' ? 'bg-red-600' : 'bg-green-600'}`;
            toastMessage.textContent = message;
            toast.classList.remove('translate-x-full');
            
            setTimeout(() => {
                toast.classList.add('translate-x-full');
            }, 3000);
        }
    </script>
</body>
</html>
